server:
  port: 8080
  http2:
    enabled: true
  servlet:
    encoding:
      enabled: true
      force: true
      charset: UTF-8
spring:
  application:
    name: api-gateway
  main:
    web-application-type: reactive
  data:
    redis:
      cluster:
        nodes: ${spring_data_redis_cluster_nodes:redis-cluster-svc.default.svc.cluster.local:6379}
  cloud:
    discovery:
      client:
        health-indicator:
          enabled: false
    kubernetes:
      discovery:
        enabled: true
        discovery-server-url: http://api-registry-int-svc:7000
    gateway:
      server:
        webflux:
          globalcors:
            cors-configurations:
              config:
                allowedmethods: "*"
                allowedheaders: "*"
                maxage: "3600"
                allowedoriginpatterns: "https://*.example.com"
          httpclient:
            wiretap: true
            pool.metrics: ${api.gateway.metrics.enabled}
          metrics:
            enabled: ${api.gateway.metrics.gateway-requests.enabled}
            prefix: ${api.gateway.metrics.gateway-requests.prefix}
      filter:
        redis.cache.enabled: false
      default-filters:
        - AddResponseHeader=Strict-Transport-Security, max-age=31536000; includeSubDomains
        - name: RequestHeaderFilter
          args:
            remove-unknown-headers: ${api_gateway_request-header-filter_remove_unknown_headers:true}
            skip-validation-for-apis: ${api_gateway_request-header-filter_skip_validation_for_apis:/api-docs/**,/v3/api-docs/**}
            allow-headers: ${api_gateway_request-header-filter_allow_headers:host, connection, content-type, content-length, accept, user-agent, "content-type, origin, referer, accept-encoding, accept-language, authorization, serviceName}
            append-headers-if-missing: ${api_gateway_request-header-filter_append_headers_if_missing:correlationId}
            global-headers:
              - name: correlationId
                required: true # first level
                regex: "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$" # second level

jwt:
  keySources:
  - id: test
    type: PEM
    location: /api-gateway/test.pem
    default: true
  - id: uidam
    type: JWKS
    issuer: https://uidam-authorization-server
    url: https://uidam-authorization-server:9443/oauth2/jwks
    refreshInterval: "5m"
  tokenHeaderValidationConfig:
    accountId:
      required: false
      regex: "^[a-zA-Z0-9]+$"
    tenantId:
      required: false
      regex: "^[a-zA-Z0-9]+$"
  # token claim to request header mapping
  tokenClaimToHeaderMapping:
    sub: "x-user-id"
    email: "user-email"
    user_id: "user-id"
    tenantId: "tenantId"
    accountId: "accountId"
requestBody:
  validation: true

# Schedular to refresh the api-routes for every 30 sec
api:
  registry:
    enabled: ${api_registry_enabled:true}
    base-url: ${api_registry_base-url:http://api-registry-int-svc:7000}
    route-path: /api/v1/routes
  isFilterOverrideEnabled: false
  overrideFilterConfig:
    JwtAuthValidator:
      filterName: CustomValidator
  caching:
    type: "redis"
    enabled: true
    cacheName: "DefaultCache"
    ttl: 5
  routes:
    refreshCronJob: "*/30 * * * * *"
  dynamic:
    routes:
      enabled: true
  registered:
    services: "test-dmap"
  userId:
    field: "sub"
  gateway:
    routes: ## Event-driven route refresh configuration
      refresh:
        strategy: ${ROUTE_REFRESH_STRATEGY:POLLING}
        redis:
          channel: ${ROUTE_REFRESH_REDIS_CHANNEL:route-updates}
          connection-timeout-ms: ${REDIS_CONNECTION_TIMEOUT:5000}
        retry:
          max-attempts: ${RETRY_MAX_ATTEMPTS:5}
          initial-interval-ms: ${RETRY_INITIAL_INTERVAL:1000}
          multiplier: ${RETRY_MULTIPLIER:2.0}
          max-interval-ms: ${RETRY_MAX_INTERVAL:16000}
        polling:
          cron-expression: ${ROUTE_REFRESH_POLLING_CRON:*/30 * * * * *}
    rate-limit: ## Rate Limiting Configuration
      enabled: true 
      max-burst-capacity: 10000
      max-replenish-rate: 10000
      max-requested-tokens: 100
      key-resolvers: CLIENT_IP, client-ip, clientIpKeyResolver, HEADER, header, headerKeyResolver, ROUTE_NAME, route-name, routeNameKeyResolver, ROUTE_PATH, route-path, routePathKeyResolver
      defaults:
        replenish-rate: ${RATE_LIMIT_REPLENISH_RATE:50}
        burst-capacity: ${RATE_LIMIT_BURST_CAPACITY:100}
        requested-tokens: 1
        deny-empty-key: true
        empty-key-status: 400
        key-resolver: clientIpKeyResolver
        include-headers: true
    metrics: ## Metrics Configuration
      enabled: true
      port: 9101
      base-path: /gateway
      prometheus:
        enabled: true
        path: /metrics
      datadog:
        enabled: false
        uri: https://api.datadoghq.com
        api-key: CHANGE_ME
        application-key: ""
        read-timeout: 5s
        connect-timeout: 5s
        batch-size: 1000
        step: 1m
        host-tag: "api-gateway"
      health:
        enabled: true
        path: /health
      security-metrics:
        enabled: true
        prefix: api.gateway
        ignoreTags: [ "exception" ]
        security-filter-name: JwtAuthFilter
      public-key-cache:
        enabled: true
        cache-size:
          name: public_key_cache_size
        key-sources:
          name: public_key_sources_count
      gateway-requests:
        enabled: true
        prefix: api.gateway
        ignoreTags: [ "exception" ]
        distribution:
          enabled: false # if enabled meter registry publishes 276 predetermined histogram buckets
          buckets: 100ms, 500ms, 1000ms, 3000ms, 5000ms, 8000ms, 10000ms, 15000ms  # slo thresholds in milliseconds
          expiry: 5m
          bufferLength: 10
      backend-requests:
        prefix: http.backend.requests
        enabled: true
        ignoreTags: [ "exception" ]
        distribution:
          enabled: false
          buckets: 100ms, 500ms, 1000ms, 3000ms, 5000ms, 8000ms, 10000ms, 15000ms  # slo thresholds in milliseconds
          expiry: 5m
          bufferLength: 10
      server-requests:
        prefix: http.server.requests
        enabled: true
        ignoreTags: [ "exception" ]
        distribution:
          enabled: false
          buckets: 100ms, 500ms, 1s, 3s, 5s, 8s, 10s, 15s  # slo thresholds in milliseconds
          expiry: 5m
          bufferLength: 10
      http-client-requests:
        prefix: http.client.requests
        enabled: true
        ignoreTags: [ "exception" ]
        distribution:
          enabled: false
          buckets: 100ms, 500ms, 1000ms, 3000ms, 5000ms, 8000ms, 10000ms, 15000ms  # slo thresholds in milliseconds
          expiry: 5m
          bufferLength: 10
    client-access-control: ## Client Access Control Configuration
      enabled: false
      claim-names:
      - client_id
      - clientId
      - client-id
      skip-paths:
      - /api-docs/**
      - /v3/api-docs/**
springdoc:
  version: '@springdoc.version@'
  swagger-ui:
    use-root-path: true
logging:
  level:
    org.springframework.cloud.gateway: ERROR
    org.springframework.boot.context.config: ERROR
    org.springframework.boot.loader: ERROR
## Plugin configurations
plugin:
  enabled: ${plugin_enabled:false}
  path: ${plugin_path:/external-libs}
  classes: ${plugin_classes:}

api-gateway:
  uri: ${api_gateway_uri:http://api-gateway-int-svc:7000/}

# spring actuator configurations
management:
  server:
    port: ${api.gateway.metrics.port:9100}
  endpoints:
    web:
      base-path: ${api.gateway.metrics.base-path:/gateway}
      path-mapping:
        prometheus: ${api.gateway.metrics.prometheus.path:/metrics}
        health: ${api.gateway.metrics.health.path:/health}
      exposure:
        include: health, prometheus
    access:
      default: none
  endpoint:
    prometheus:
      access: read-only
    health:
      probes:
        enabled: ${api.gateway.metrics.health.enabled:true}
      access: read-only
  prometheus:
    metrics:
      export:
        enabled: ${api.gateway.metrics.prometheus.enabled:true}
  datadog:
    metrics:
      export:
        enabled: ${api.gateway.metrics.datadog.enabled:false}
        uri: ${api.gateway.metrics.datadog.uri:https://api.datadoghq.com}
        api-key: ${api.gateway.metrics.datadog.api-key:}
        application-key: ${api.gateway.metrics.datadog.application-key:}
        read-timeout: ${api.gateway.metrics.datadog.read-timeout:5s}
        connect-timeout: ${api.gateway.metrics.datadog.connect-timeout:5s}
        batch-size: ${api.gateway.metrics.datadog.batch-size:1000}
        step: ${api.gateway.metrics.datadog.step:1m}
        host-tag: ${api.gateway.metrics.datadog.host-tag:api-gateway}
  default:
    metrics:
      export:
        enabled: false
  metrics:
    tags:
      env: ${env:local}
      host: ${HOSTNAME:localhost}
      application: ${spring.application.name:api-gateway}
